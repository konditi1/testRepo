{{define "view-document"}}
{{template "header" .}}
<section class="container document-detail-page">
    <div class="document-detail-header">
        <div class="document-icon">
            {{if eq .Document.FileType "pdf"}}
            <i class="fa-regular fa-file-pdf document-icon-pdf"></i>
            {{else if eq .Document.FileType "word"}}
            <i class="fa-regular fa-file-word document-icon-word"></i>
            {{else if eq .Document.FileType "excel"}}
            <i class="fa-regular fa-file-excel document-icon-excel"></i>
            {{else if eq .Document.FileType "powerpoint"}}
            <i class="fa-regular fa-file-powerpoint document-icon-powerpoint"></i>
            {{else if eq .Document.FileType "image"}}
            <i class="fa-regular fa-file-image document-icon-image"></i>
            {{else if eq .Document.FileType "video"}}
            <i class="fa-regular fa-file-video document-icon-video"></i>
            {{else if eq .Document.FileType "audio"}}
            <i class="fa-regular fa-file-audio document-icon-audio"></i>
            {{else if eq .Document.FileType "archive"}}
            <i class="fa-regular fa-file-archive document-icon-archive"></i>
            {{else}}
            <i class="fa-regular fa-file document-icon-other"></i>
            {{end}}
        </div>
        <div class="document-detail-content">
            <h1>{{.Document.Title}}</h1>
            <div class="document-meta">
                <div class="document-author">
                    {{if .Document.AuthorProfileURL}}
                    <img src="{{.Document.AuthorProfileURL}}" alt="{{.Document.Username}}'s profile" class="author-image">
                    {{else}}
                    <i class="fa-regular fa-user"></i>
                    {{end}}
                    <span>Uploaded by <a href="/view-profile?username={{.Document.Username}}">{{.Document.Username}}</a></span>
                </div>
                <div class="document-info">
                    <span class="document-date">{{.Document.CreatedAtHuman}}</span>
                    <span class="document-version">Version {{.Document.Version}}</span>
                    <span class="document-downloads"><i class="fa-solid fa-download"></i> {{.Document.DownloadCount}} downloads</span>
                </div>
            </div>
        </div>
        <div class="document-detail-actions">
            <a href="{{.Document.FileURL}}" target="_blank" class="btn-download" title="Download"><i class="fa-solid fa-download"></i> Download</a>
            {{if .Document.IsOwner}}
            <form action="/delete-document?id={{.Document.ID}}" method="POST" onsubmit="return confirm('Are you sure you want to delete this document?');">
                <button type="submit" class="btn-delete" title="Delete"><i class="fa-solid fa-trash"></i> Delete</button>
            </form>
            {{end}}
        </div>
    </div>

    <div class="document-content-container">
        <div class="document-description-section">
            <h2>Description</h2>
            {{if .Document.Description}}
            <p>{{.Document.Description}}</p>
            {{else}}
            <p class="no-description">No description provided</p>
            {{end}}
            
            {{if .Document.TagsArray}}
            <div class="document-tags">
                <h3>Tags</h3>
                <div class="tags-list">
                    {{range .Document.TagsArray}}
                    <a href="/documents?tag={{.}}" class="document-tag">{{.}}</a>
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>

        <div class="document-preview-container">
            <h2>Preview</h2>
            {{if eq .Document.FileType "pdf"}}
            <div class="pdf-preview">
                <iframe src="{{.Document.FileURL}}" width="100%" height="600px"></iframe>
            </div>
            {{else if eq .Document.FileType "image"}}
            <div class="image-preview">
                <img src="{{.Document.FileURL}}" alt="{{.Document.Title}}">
            </div>
            {{else}}
            <div class="preview-not-available">
                <i class="fa-solid fa-eye-slash"></i>
                <p>Preview not available for this file type</p>
                <a href="{{.Document.FileURL}}" target="_blank" class="btn-view-external">Open file to view content</a>
            </div>
            {{end}}
        </div>
    </div>

    <div class="document-comments-section">
        <h2>Comments <span class="comments-count">{{.Document.CommentsCount}}</span></h2>
        
        {{if .IsLoggedIn}}
        <div class="comment-form-container">
            <form action="/document-comment" method="POST" class="comment-form">
                <input type="hidden" name="document_id" value="{{.Document.ID}}">
                <div class="comment-input">
                    <textarea name="comment" rows="3" placeholder="Add your comment..." required></textarea>
                </div>
                <button type="submit" class="btn-submit-comment">Post Comment</button>
            </form>
        </div>
        {{else}}
        <div class="login-to-comment">
            <p>Please <a href="/login">log in</a> to leave a comment.</p>
        </div>
        {{end}}
        
        <div class="comments-list">
            {{if .Comments}}
                {{range .Comments}}
                <div class="comment-card" id="comment-{{.ID}}">
                    <div class="comment-header">
                        <div class="comment-author">
                            {{if .AuthorProfileURL}}
                            <img src="{{.AuthorProfileURL}}" alt="{{.Username}}'s profile" class="author-image">
                            {{else}}
                            <i class="fa-regular fa-user"></i>
                            {{end}}
                            <div>
                                <a href="/view-profile?username={{.Username}}" class="author-name">{{.Username}}</a>
                                <span class="comment-date">{{.CreatedAtHuman}}</span>
                            </div>
                        </div>
                        {{if .IsOwner}}
                        <div class="comment-actions">
                            <button class="btn-edit-comment" data-id="{{.ID}}"><i class="fa-regular fa-pen-to-square"></i></button>
                            <form action="/delete-comment?id={{.ID}}" method="POST" class="delete-comment-form" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                <button type="submit" class="btn-delete-comment"><i class="fa-regular fa-trash-can"></i></button>
                            </form>
                        </div>
                        {{end}}
                    </div>
                    <div class="comment-content">
                        <p>{{.Content}}</p>
                    </div>
                </div>
                {{end}}
            {{else}}
            <div class="no-comments">
                <i class="fa-regular fa-comments"></i>
                <p>No comments yet. Be the first to comment!</p>
            </div>
            {{end}}
        </div>
    </div>
</section>

<style>
.document-detail-page {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 0 1rem;
}

.document-detail-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.document-icon {
    font-size: 3rem;
    flex-shrink: 0;
}

.document-detail-content {
    flex-grow: 1;
}

.document-detail-content h1 {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
    color: #1f2937;
}

.document-meta {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
}

.document-author {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.author-image {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
}

.document-info {
    display: flex;
    gap: 1rem;
}

.document-date, .document-version, .document-downloads {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.document-detail-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.btn-download, .btn-delete {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    color: white;
    text-decoration: none;
    font-weight: 500;
    transition: background-color 0.2s;
}

.btn-download {
    background-color: #10b981;
}

.btn-delete {
    background-color: #ef4444;
    border: none;
    cursor: pointer;
}

.btn-download:hover { background-color: #059669; }
.btn-delete:hover { background-color: #dc2626; }

.document-content-container {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.document-description-section, .document-preview-container {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
}

.document-description-section h2, .document-preview-container h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.25rem;
    color: #1f2937;
}

.document-description-section p {
    margin-bottom: 1.5rem;
    color: #4b5563;
}

.no-description {
    font-style: italic;
    color: #9ca3af;
}

.document-tags h3 {
    font-size: 1rem;
    margin-bottom: 0.75rem;
    color: #4b5563;
}

.tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.document-tag {
    background-color: #f3f4f6;
    color: #4b5563;
    font-size: 0.875rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    text-decoration: none;
    transition: background-color 0.2s;
}

.document-tag:hover {
    background-color: #e5e7eb;
}

.pdf-preview, .image-preview {
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
}

.image-preview img {
    max-width: 100%;
    height: auto;
    display: block;
}

.preview-not-available {
    text-align: center;
    padding: 3rem 0;
    color: #6b7280;
}

.preview-not-available i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #d1d5db;
}

.btn-view-external {
    display: inline-block;
    margin-top: 1rem;
    background-color: #f3f4f6;
    color: #4b5563;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    text-decoration: none;
    transition: background-color 0.2s;
}

.btn-view-external:hover {
    background-color: #e5e7eb;
}

.document-comments-section {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
}

.document-comments-section h2 {
    margin-top: 0;
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
    color: #1f2937;
    display: flex;
    align-items: center;
}

.comments-count {
    margin-left: 0.5rem;
    background-color: #f3f4f6;
    color: #4b5563;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
}

.comment-form-container {
    margin-bottom: 2rem;
}

.comment-form {
    display: flex;
    flex-direction: column;
}

.comment-input {
    margin-bottom: 1rem;
}

.comment-input textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    resize: vertical;
}

.btn-submit-comment {
    align-self: flex-end;
    background-color: #3b82f6;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.btn-submit-comment:hover {
    background-color: #2563eb;
}

.login-to-comment {
    margin-bottom: 2rem;
    padding: 1rem;
    background-color: #f9fafb;
    border-radius: 6px;
    text-align: center;
    color: #6b7280;
}

.login-to-comment a {
    color: #3b82f6;
    text-decoration: none;
    font-weight: 500;
}

.login-to-comment a:hover {
    text-decoration: underline;
}

.comments-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.comment-card {
    padding: 1rem;
    background-color: #f9fafb;
    border-radius: 6px;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.75rem;
}

.comment-author {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.author-name {
    display: block;
    font-weight: 500;
    color: #1f2937;
    text-decoration: none;
}

.author-name:hover {
    color: #3b82f6;
}

.comment-date {
    font-size: 0.75rem;
    color: #6b7280;
}

.comment-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-edit-comment, .btn-delete-comment {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    transition: color 0.2s;
    padding: 0.25rem;
}

.btn-edit-comment:hover { color: #3b82f6; }
.btn-delete-comment:hover { color: #ef4444; }

.comment-content {
    color: #4b5563;
}

.no-comments {
    text-align: center;
    padding: 3rem 0;
    color: #6b7280;
}

.no-comments i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #d1d5db;
}

.document-icon-pdf { color: #ef4444; }
.document-icon-word { color: #2563eb; }
.document-icon-excel { color: #16a34a; }
.document-icon-powerpoint { color: #ea580c; }
.document-icon-image { color: #8b5cf6; }
.document-icon-video { color: #ec4899; }
.document-icon-audio { color: #06b6d4; }
.document-icon-archive { color: #f59e0b; }
.document-icon-other { color: #6b7280; }

/* Responsive styles */
@media (max-width: 768px) {
    .document-detail-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .document-detail-actions {
        flex-direction: row;
        width: 100%;
        margin-top: 1rem;
    }
    
    .document-content-container {
        grid-template-columns: 1fr;
    }
    
    .btn-download, .btn-delete {
        flex: 1;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Edit comment functionality (if needed)
    const editButtons = document.querySelectorAll('.btn-edit-comment');
    
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.getAttribute('data-id');
            const commentCard = document.getElementById(`comment-${commentId}`);
            const commentContent = commentCard.querySelector('.comment-content p').textContent;
            
            const formHtml = `
                <form action="/edit-comment?id=${commentId}" method="POST" class="edit-comment-form">
                    <textarea name="content" rows="3" required>${commentContent}</textarea>
                    <div class="edit-actions">
                        <button type="submit" class="btn-save">Save</button>
                        <button type="button" class="btn-cancel">Cancel</button>
                    </div>
                </form>
            `;
            
            commentCard.querySelector('.comment-content').innerHTML = formHtml;
            
            // Cancel edit
            commentCard.querySelector('.btn-cancel').addEventListener('click', function() {
                commentCard.querySelector('.comment-content').innerHTML = `<p>${commentContent}</p>`;
            });
        });
    });
});
</script>
{{end}}